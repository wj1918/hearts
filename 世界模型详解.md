# 30个世界模型详解

## 问题：隐藏信息

在红心大战中，你只能看到自己的13张牌。其他39张牌隐藏在3个对手中。

```
你知道的：    ♠AKQ ♥J32 ♦T98 ♣7654  (13张牌)
你不知道的：  ??? ??? ???           (3个玩家的39张牌)
```

AI无法搜索单一的博弈树，因为它不知道真实状态。

---

## 解决方案：采样多个"世界"

不是猜测一种牌的分布，而是基于以下信息生成**30种可能的分布**：
- 已经打出的牌
- 谁缺哪个花色
- 传牌信息
- 概率计算

```
世界1：  玩家B有♠J，玩家C有♥Q，玩家D有♦K...
世界2：  玩家B有♥Q，玩家C有♦K，玩家D有♠J...
世界3：  玩家B有♦K，玩家C有♠J，玩家D有♥Q...
...
世界30： (另一种一致的分布)
```

---

## 工作原理

```
对于每个决策：
┌─────────────────────────────────────────────────────┐
│  生成30个一致的世界模型                              │
│                                                     │
│  对于每个世界(1-30)：                               │
│    └── 运行UCT算法进行333次模拟                      │
│        └── 返回："打♠K得分2.5分"                    │
│                                                     │
│  合并所有30个世界的结果：                            │
│    ♠K: 各世界平均2.5分                              │
│    ♥3: 各世界平均4.1分                              │
│    ♦9: 各世界平均3.2分                              │
│                                                     │
│  选择：♠K (平均得分最低)                            │
└─────────────────────────────────────────────────────┘
```

---

## 为什么是30个？

| 模型数 | 准确性 | 速度 |
|--------|----------|-------|
| 1 | 差 - 单次猜测可能错误 | 快 |
| 10 | 中等 | 快 |
| **30** | **良好平衡** | **合理** |
| 100 | 优秀 | 慢 |
| 1000 | 收益递减 | 非常慢 |

30个模型在不过度计算的情况下提供了可能牌分布的统计覆盖。

---

## 代码位置

```cpp
// iiMonteCarlo.cpp
iiMonteCarlo::iiMonteCarlo(Algorithm *a, iiGameState *s, int numModels)
{
    // numModels = 30 (通常)
    // 对于每个模型，生成一致的世界并运行算法
}
```

---

## 决策规则

在所有30个世界上运行UCT后，使用以下方法合并结果：

| 规则 | 方法 |
|------|--------|
| `kMaxWeighted` | 按每个世界的概率加权 |
| `kMaxAverage` | 各世界的简单平均 |
| `kMaxAvgVar` | 考虑方差(优选一致的走法) |
| `kMaxMinScore` | 悲观 - 假设最坏情况 |

---

## 示例

```
决定是否打出♠Q(黑桃皇后)：

世界1：  ♠Q输掉这墩 → +0分  (别人有更大的黑桃)
世界2：  ♠Q赢得这墩 → +13分 (你吃到猪)
世界3：  ♠Q输掉这墩 → +0分
...
世界30： ♠Q赢得这墩 → +13分

平均：6.5分 (有风险！)

对比♠2：
所有世界：♠2输掉这墩 → +0分
平均：0分 (安全)

决策：打出♠2
```

这就是AI在不知道确切牌的情况下如何推理不确定性。

---

## 技术细节

### 世界生成 (iiGameState)

三个级别的对手建模决定了世界的生成方式：

| 模型 | 类 | 复杂度 |
|-------|-------|----------------|
| OM-0 | `iiHeartsState` | 基本概率跟踪 |
| OM-1 | `simpleIIHeartsState` | 增强计算 |
| OM-2 | `advancedIIHeartsState` | 历史上下文 |

### 一致性约束

每个生成的世界必须满足：
1. 总牌数 = 52
2. 每个玩家拥有正确的牌数
3. 已打出的牌不在手牌中
4. 尊重缺门约束(如果玩家表现出某花色缺门)
5. 传牌约束(已传的牌是已知的)

### 概率加权

世界并非同等可能。算法跟踪：
- P(玩家有此牌 | 观察)
- 每墩牌后更新
- 考虑玩家选择不打的牌

---

## 性能

```
30个世界 × 333次UCT模拟 = 每步10,000次总模拟
```

通过多线程，可以并行评估各个世界以加快决策速度。

---

*这种技术在游戏AI文献中被称为"确定化"或"完美信息蒙特卡洛采样"。*
